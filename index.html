<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>P2P 同步 YouTube 播放器</title>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script> <!-- PeerJS CDN -->
</head>
<body>
  <div id="player"></div>
  <div id="playHint" style="display: none; background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <strong>提示：</strong> 點擊播放器開始播放視頻。由於瀏覽器安全政策，需要用戶交互才能開始播放。
  </div>
  <div id="serverConfig" style="margin: 10px 0; padding: 10px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 5px;">
    <h4 style="margin: 0 0 10px 0;">PeerJS 服務器配置 (可選)</h4>
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <input id="serverHost" placeholder="主機 (如: localhost)" style="width: 120px;" />
      <input id="serverPort" placeholder="端口 (如: 9000)" type="number" style="width: 80px;" />
      <input id="serverPath" placeholder="路徑 (如: /peerjs)" style="width: 100px;" />
      <button id="resetServerConfig" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">重置為默認</button>
    </div>
    <small style="color: #666; display: block; margin-top: 5px;">留空使用 PeerJS 默認雲服務器</small>
  </div>
  
  <button id="createRoom">建立房間 (成為 Host)</button>
  <button id="retryConnection" style="display: none; background-color: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">重試連接</button>
  <input id="roomId" placeholder="輸入 Room ID 加入" />
  <button id="joinRoom">加入房間</button>
  <div id="videoControls" style="display: none; margin-top: 10px;">
    <input id="videoId" placeholder="輸入 YouTube 視頻 ID 或完整 URL" style="width: 400px;" />
    <button id="changeVideo">更改視頻</button>
    <br>
    <small style="color: #666;">支援格式: 視頻ID (如: M7lc1UVf-VE) 或完整URL (如: https://www.youtube.com/watch?v=M7lc1UVf-VE)</small>
  </div>
  
  <div id="shareSection" style="display: none; margin-top: 15px; padding: 10px; background-color: #f0f8ff; border: 1px solid #ccc; border-radius: 5px;">
    <h3 style="margin: 0 0 10px 0; color: #333;">分享房間</h3>
    <div id="shareUrl" style="word-break: break-all; margin-bottom: 10px;"></div>
    <button id="copyUrl" style="background-color: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">複製連結</button>
    <span id="copyStatus" style="margin-left: 10px; color: #666;"></span>
  </div>
  
  <p id="status">狀態：未連線</p>

  <script>
    let player;
    let peer; // PeerJS 實例
    let conn; // 連線物件
    let isHost = false;
    let isSyncing = false; // 防止同步循環
    let lastSyncTime = 0; // 記錄最後同步時間
    let isConnected = false; // 連線狀態標誌
    let currentRoomId = null; // 保存當前房間ID
    let currentVideoId = null; // 保存當前視頻ID
    const urlParams = new URLSearchParams(window.location.search);
    const autoRoom = urlParams.get('room');
    const initialVideoId = urlParams.get('video') || 'M7lc1UVf-VE'; // 支持video參數

    // 頁面載入完成後立即設置事件監聽器
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
    });

    // YouTube 播放器初始化
    function onYouTubeIframeAPIReady() {
      currentVideoId = initialVideoId; // 設置初始視頻ID
      player = new YT.Player('player', {
        height: '390',
        width: '640',
        videoId: initialVideoId, // 使用URL參數或默認視頻ID
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    // 設置事件監聽器（不依賴YouTube API）
    function setupEventListeners() {
      document.getElementById('createRoom').onclick = createRoom;
      document.getElementById('joinRoom').onclick = joinRoom;
      document.getElementById('changeVideo').onclick = changeVideo;
      document.getElementById('copyUrl').onclick = copyShareUrl;
      document.getElementById('retryConnection').onclick = retryConnection;
      document.getElementById('resetServerConfig').onclick = resetServerConfig;
    }

    function onPlayerReady(event) {
      // 確保事件監聽器已設置
      setupEventListeners();
      
      // 添加播放器點擊事件來處理自動播放限制
      document.getElementById('player').addEventListener('click', () => {
        if (player.getPlayerState() === 5) { // 如果播放器暫停
          player.playVideo();
        }
      });

      if (autoRoom) {
        joinRoom(autoRoom);
      } else if (!isHost) {
        // 只有在沒有自動加入房間且不是host時，才載入初始視頻
        // 這樣客戶端會等待host的視頻指令
        player.loadVideoById(initialVideoId);
      }
      
      // 顯示播放提示
      setTimeout(() => {
        document.getElementById('playHint').style.display = 'block';
      }, 2000); // 2秒後顯示提示

      // 定時廣播狀態 (僅 host) - 降低頻率避免過度同步
      setInterval(() => {
        if (isHost && player.getPlayerState() === 1 && !isSyncing) {
          broadcast({ action: 'sync', time: player.getCurrentTime(), state: 'play' });
        }
      }, 2000); // 從1秒改為2秒，減少同步頻率

      // 注意：YouTube Player API 沒有直接的 seeking/seeked 事件
      // 我們可以通過監聽播放器狀態變化來檢測拖拽
      // 但為了簡化，我們暫時移除手動拖拽檢測功能
      // 用戶可以通過暫停/播放來控制同步
    }

    function onPlayerStateChange(event) {
      // 隱藏播放提示（用戶已經開始交互）
      document.getElementById('playHint').style.display = 'none';
      
      // 只有在是host且不是正在同步時才廣播狀態變化
      if (isHost && !isSyncing) {
        if (event.data === YT.PlayerState.PLAYING) {
          broadcast({ action: 'play', time: player.getCurrentTime() });
        } else if (event.data === YT.PlayerState.PAUSED) {
          broadcast({ action: 'pause', time: player.getCurrentTime() });
        }
      }
    }

    // 從YouTube URL提取視頻ID
    function extractVideoId(url) {
      const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
      const match = url.match(regex);
      return match ? match[1] : null;
    }

    // 複製分享連結
    function copyShareUrl() {
      const shareUrlElement = document.getElementById('shareUrl');
      const shareUrl = shareUrlElement.textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shareUrl).then(() => {
          document.getElementById('copyStatus').textContent = '已複製！';
          setTimeout(() => {
            document.getElementById('copyStatus').textContent = '';
          }, 2000);
        }).catch(err => {
          console.error('複製失敗:', err);
          fallbackCopyTextToClipboard(shareUrl);
        });
      } else {
        fallbackCopyTextToClipboard(shareUrl);
      }
    }

    // 備用複製方法
    function fallbackCopyTextToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.top = "0";
      textArea.style.left = "0";
      textArea.style.position = "fixed";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          document.getElementById('copyStatus').textContent = '已複製！';
          setTimeout(() => {
            document.getElementById('copyStatus').textContent = '';
          }, 2000);
        } else {
          document.getElementById('copyStatus').textContent = '複製失敗';
        }
      } catch (err) {
        console.error('複製失敗:', err);
        document.getElementById('copyStatus').textContent = '複製失敗';
      }
      
      document.body.removeChild(textArea);
    }

    // 更改視頻函數
    function changeVideo() {
      const input = document.getElementById('videoId').value.trim();
      if (!input) {
        alert('請輸入有效的 YouTube 視頻 ID 或 URL');
        return;
      }
      
      let videoId;
      
      // 檢查是否為完整URL
      if (input.includes('youtube.com') || input.includes('youtu.be')) {
        videoId = extractVideoId(input);
        if (!videoId) {
          alert('無法從 URL 中提取視頻 ID，請檢查 URL 格式');
          return;
        }
      } else {
        // 直接使用輸入作為視頻ID
        videoId = input;
      }
      
      // 驗證視頻ID格式（YouTube視頻ID通常是11個字符）
      if (videoId.length !== 11) {
        alert('YouTube 視頻 ID 應該是 11 個字符長度');
        return;
      }
      
      if (isHost) {
        // Host 更改視頻並廣播給所有客戶端
        try {
          player.loadVideoById(videoId);
          currentVideoId = videoId; // 更新當前視頻ID
          broadcast({ action: 'changeVideo', videoId: videoId });
          document.getElementById('videoId').value = '';
          
          // 更新分享連結以包含新的視頻ID
          if (currentRoomId) {
            const shareUrl = `${location.origin}${location.pathname}?room=${currentRoomId}&video=${videoId}`;
            document.getElementById('shareUrl').textContent = shareUrl;
            document.getElementById('status').textContent = `已更改視頻: ${videoId}`;
          } else {
            document.getElementById('status').textContent = `已更改視頻: ${videoId}`;
          }
        } catch (error) {
          alert('無法載入視頻，請檢查視頻 ID 是否正確');
          console.error('載入視頻錯誤:', error);
        }
      } else {
        alert('只有 Host 可以更改視頻');
      }
    }

    // 重試連接
    function retryConnection() {
      console.log('重試連接');
      document.getElementById('retryConnection').style.display = 'none';
      document.getElementById('createRoom').style.display = 'inline-block';
      createRoom();
    }

    // 重置服務器配置
    function resetServerConfig() {
      document.getElementById('serverHost').value = '';
      document.getElementById('serverPort').value = '';
      document.getElementById('serverPath').value = '';
      console.log('服務器配置已重置為默認');
    }

    // 獲取服務器配置
    function getServerConfig() {
      const host = document.getElementById('serverHost').value.trim();
      const port = document.getElementById('serverPort').value.trim();
      const path = document.getElementById('serverPath').value.trim();
      
      // 如果所有字段都為空，返回null使用默認配置
      if (!host && !port && !path) {
        return null;
      }
      
      const config = {};
      
      // 驗證和設置主機
      if (host) {
        // 基本的主機名驗證
        if (host.length > 0) {
          config.host = host;
        }
      }
      
      // 驗證和設置端口
      if (port) {
        const portNum = parseInt(port);
        if (portNum > 0 && portNum <= 65535) {
          config.port = portNum;
        } else {
          console.warn('無效的端口號:', port);
          alert('端口號必須在 1-65535 範圍內');
          return null;
        }
      }
      
      // 驗證和設置路徑
      if (path) {
        // 確保路徑以 / 開頭
        config.path = path.startsWith('/') ? path : '/' + path;
      }
      
      // 添加調試模式
      config.debug = 3;
      
      return config;
    }

    // 建立房間 (Host)
    function createRoom() {
      console.log('建立房間按鈕被點擊');
      document.getElementById('status').textContent = '正在建立房間...';
      
      // 檢查PeerJS是否可用
      if (typeof Peer === 'undefined') {
        console.error('PeerJS 未載入');
        document.getElementById('status').textContent = 'PeerJS 未載入，請刷新頁面重試';
        return;
      }
      
      // 設置連接超時
      const connectionTimeout = setTimeout(() => {
        if (!isHost) {
          document.getElementById('status').textContent = '建立房間超時，請檢查網絡連接或稍後重試';
          document.getElementById('createRoom').style.display = 'none';
          document.getElementById('retryConnection').style.display = 'inline-block';
          console.error('PeerJS 連接超時');
        }
      }, 10000); // 10秒超時
      
      try {
        console.log('創建 Peer 實例...');
        
        // 獲取用戶配置
        const serverConfig = getServerConfig();
        console.log('服務器配置:', serverConfig);
        
        // 創建Peer實例
        if (serverConfig) {
          // 使用自定義服務器配置
          peer = new Peer('', serverConfig);
          console.log('使用自定義服務器配置:', serverConfig);
        } else {
          // 使用默認PeerJS雲服務器
          peer = new Peer();
          console.log('使用默認PeerJS雲服務器');
        }
        
        peer.on('open', (id) => {
          console.log('房間建立成功，ID:', id);
          clearTimeout(connectionTimeout); // 清除超時
          
          currentRoomId = id; // 保存房間ID
          const shareUrl = `${location.origin}${location.pathname}?room=${id}&video=${initialVideoId}`;
          
          // 更新分享區域
          document.getElementById('shareUrl').textContent = shareUrl;
          document.getElementById('shareSection').style.display = 'block';
          
          // 更新狀態
          document.getElementById('status').textContent = `房間已建立！房間 ID: ${id}`;
          
          isHost = true;
          // 顯示視頻控制面板
          document.getElementById('videoControls').style.display = 'block';
        });
        
        peer.on('error', (err) => {
          console.error('PeerJS 錯誤:', err);
          console.error('錯誤類型:', err.type);
          console.error('錯誤消息:', err.message);
          clearTimeout(connectionTimeout); // 清除超時
          
          let errorMessage = '建立房間失敗';
          if (err.type === 'unavailable-id') {
            errorMessage = '房間ID不可用，請重試';
          } else if (err.type === 'network') {
            errorMessage = '網絡連接失敗，請檢查網絡';
          } else if (err.type === 'server-error') {
            errorMessage = '服務器錯誤，請稍後重試';
          } else if (err.type === 'browser-incompatible') {
            errorMessage = '瀏覽器不兼容，請使用Chrome、Firefox或Safari';
          } else if (err.type === 'ssl-unavailable') {
            errorMessage = '需要HTTPS連接，請使用安全連接';
          } else {
            errorMessage = `建立房間失敗: ${err.type} - ${err.message}`;
          }
          
          document.getElementById('status').textContent = errorMessage;
          document.getElementById('createRoom').style.display = 'none';
          document.getElementById('retryConnection').style.display = 'inline-block';
        });
        
        peer.on('connection', (connection) => {
          conn = connection;
          setupConn(conn);
          
          // 當有新客戶端連接時，立即發送當前視頻信息
          connection.on('open', () => {
            setTimeout(() => {
              if (currentVideoId) {
                broadcast({ action: 'changeVideo', videoId: currentVideoId });
              }
            }, 1000); // 延遲1秒確保連線穩定
          });
        });
        
      } catch (error) {
        console.error('建立房間時發生錯誤:', error);
        document.getElementById('status').textContent = `建立房間失敗: ${error.message}`;
      }
    }

    // 加入房間 (Peer)
    function joinRoom(roomId) {
      if (!roomId && !autoRoom) roomId = document.getElementById('roomId').value;
      if (!roomId) return alert('請輸入 Room ID');

      // 獲取用戶配置
      const serverConfig = getServerConfig();
      console.log('加入房間 - 服務器配置:', serverConfig);
      
      // 創建Peer實例
      if (serverConfig) {
        // 使用自定義服務器配置
        peer = new Peer('', serverConfig);
        console.log('加入房間 - 使用自定義服務器配置:', serverConfig);
      } else {
        // 使用默認PeerJS雲服務器
        peer = new Peer();
        console.log('加入房間 - 使用默認PeerJS雲服務器');
      }
      
      peer.on('open', () => {
        conn = peer.connect(roomId);
        setupConn(conn);
      });
      
      peer.on('error', (err) => {
        console.error('加入房間時發生錯誤:', err);
        document.getElementById('status').textContent = `加入房間失敗: ${err.type} - ${err.message}`;
      });
    }

    // 設定連線事件
    function setupConn(connection) {
      conn = connection;
      conn.on('open', () => {
        isConnected = true;
        document.getElementById('status').textContent = '連線成功！';
        
        // 如果是客戶端且連線成功，請求host發送當前視頻信息
        if (!isHost) {
          broadcast({ action: 'requestVideoInfo' });
        }
      });

      conn.on('data', (data) => {
        if (!isHost) {
          handleSync(data);
        } else if (isHost && data.action === 'requestVideoInfo') {
          // Host收到客戶端請求，發送當前視頻信息
          if (currentVideoId) {
            broadcast({ 
              action: 'changeVideo', 
              videoId: currentVideoId 
            });
          }
        }
      });
    }

    // 廣播函數
    function broadcast(data) {
      if (conn && conn.open) {
        conn.send(data);
      }
    }

    // 接收同步 (peers)
    function handleSync(data) {
      // 防止重複同步和時間過於頻繁的同步
      const currentTime = Date.now();
      if (isSyncing || (currentTime - lastSyncTime < 500)) {
        return;
      }
      
      isSyncing = true;
      lastSyncTime = currentTime;
      
      try {
        if (data.action === 'play') {
          player.seekTo(data.time, true);
          player.playVideo();
        } else if (data.action === 'pause') {
          player.seekTo(data.time, true);
          player.pauseVideo();
        } else if (data.action === 'sync') {
          player.seekTo(data.time, true);
          if (data.state === 'play') {
            player.playVideo();
          } else {
            player.pauseVideo();
          }
        } else if (data.action === 'seek') {
          player.seekTo(data.time, true);
        } else if (data.action === 'changeVideo') {
          // 客戶端接收視頻更改指令
          try {
            player.loadVideoById(data.videoId);
            currentVideoId = data.videoId; // 更新當前視頻ID
            document.getElementById('status').textContent = `已同步到視頻: ${data.videoId}`;
          } catch (error) {
            console.error('載入視頻錯誤:', error);
          }
        }
      } catch (error) {
        console.error('同步錯誤:', error);
      } finally {
        // 延遲重置同步標誌，避免立即觸發狀態變化
        setTimeout(() => {
          isSyncing = false;
        }, 1000);
      }
    }

  </script>
</body>
</html>